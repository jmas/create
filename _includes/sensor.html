<dl>
  <dt>Дата оновлення:</dt>
  <dd id="sens-date">Н/Д</dd>
  <dt>Температура:</dt>
  <dd id="sens-temp">Н/Д</dd>
  <dt>Вологість:</dt>
  <dd id="sens-hum">Н/Д</dd>
  <dt>Тиск:</dt>
  <dd id="sens-pres">Н/Д</dd>
  <dt>Опис:</dt>
  <dd id="sens-descr">Н/Д</dd>
</dl>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const weatherFeelings = [
  {
    condition: (t, h) => t < 0,
    text: "Екстремальний холод: високий ризик обмороження, організм активно спалює калорії для обігріву."
  },
  {
    condition: (t, h) => t >= 0 && t < 10 && h > 70,
    text: "Пронизлива вогкість: холодне вологе повітря інтенсивно відбирає тепло, відчувається холодніше, ніж є насправді."
  },
  {
    condition: (t, h) => t >= 0 && t < 12 && h <= 70,
    text: "Холодно та свіжо: прийнятний рівень для активного руху, але потребує багатошарового одягу."
  },
  {
    condition: (t, h) => t >= 12 && t < 18,
    text: "Бадьора прохолода: ідеально для фізичної активності, дихання легке, організм у тонусі."
  },
  {
    condition: (t, h) => t >= 18 && t < 22 && h <= 60,
    text: "Легкий комфорт: оптимальний стан для відпочинку, концентрація уваги на високому рівні."
  },
  {
    condition: (t, h) => t >= 22 && t <= 25 && h >= 30 && h <= 55,
    text: "Термічна нейтральність: ідеальний баланс, серцево-судинна система працює в економному режимі."
  },
  {
    condition: (t, h) => t > 25 && t <= 28 && h <= 50,
    text: "Приємне тепло: відчувається літній комфорт, механізми терморегуляції працюють м'яко."
  },
  {
    condition: (t, h) => t >= 23 && t <= 27 && h > 65,
    text: "Млява задуха: через вологість випаровування поту ускладнене, можливе відчуття сонливості."
  },
  {
    condition: (t, h) => t > 28 && t <= 33 && h <= 40,
    text: "Суха спека: навантаження на серце зростає, необхідно збільшити споживання води."
  },
  {
    condition: (t, h) => t > 28 && t <= 34 && h > 40,
    text: "Важка спека: ризик перегріву, судини розширені, працездатність суттєво знижується."
  },
  {
    condition: (t, h) => t > 34 && h > 50,
    text: "Критична задуха: ризик теплового удару, природне охолодження майже неможливе. Небезпечно для серця!"
  },
  {
    condition: (t, h) => t > 34 && h <= 50,
    text: "Екстремальна температура: організм працює на межі можливостей, інтенсивне потовиділення."
  }
];

function getDetailedFeeling(temp, humidity) {
  const result = weatherFeelings.find(f => f.condition(temp, humidity));
  return result ? result.text : "Стан адаптації: організм підлаштовується під умови.";
}

    const rtf = new Intl.RelativeTimeFormat(document.documentElement.lang, { numeric: "auto" });

    function formatTimeAgo(date) {
      const now = new Date();
      const diffInMilliseconds = now - date;
      const seconds = Math.floor(diffInMilliseconds / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      const months = Math.floor(days / 30);
      const years = Math.floor(months / 12);

      if (years > 0) {
          return rtf.format(-years, "year");
      } else if (months > 0) {
          return rtf.format(-months, "month");
      } else if (days > 0) {
          return rtf.format(-days, "day");
      } else if (hours > 0) {
          return rtf.format(-hours, "hour");
      } else if (minutes > 0) {
          return rtf.format(-minutes, "minute");
      } else {
          return rtf.format(-seconds, "second");
      }
    }

    /* MAIN */

    const messages = new Map();

    const dateOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    };

    const options = {
        username: 'website',
        password: 'SKQCWqw6e8JW6Gj',
        clientId: `mqttjs_${Math.random().toString(16).substring(2, 8)}`
    };
    
    const client = mqtt.connect('wss://81e95e73d74f4efd837464022a52355a.s1.eu.hivemq.cloud:8884/mqtt', options);
    
    client.on('connect', function () {
        console.info('Connected to broker MQTT');
        client.subscribe('tele/tasmota_8D7614/SENSOR', function (err) {
            console.info('Error?', err);
        });
    });
    
    client.on('message', function (topic, message) {
        const data = JSON.parse(message.toString());

        console.info('Message', data);

        messages.set(new Date(data.Time), data);

	const latestKey = Array.from(messages.keys()).sort().at(-1);
	const latestMessage = messages.get(latestKey);
	const date = new Date(latestMessage.Time);

        document.getElementById('sens-date').innerText = `${new Intl.DateTimeFormat(document.documentElement.lang, dateOptions).format(date)} (${formatTimeAgo(date)})`;
        document.getElementById('sens-temp').innerText = `${latestMessage.BME280.Temperature > 0 ? '+' : '-'}${latestMessage.BME280.Temperature} °C`;
        document.getElementById('sens-hum').innerText = latestMessage.BME280.Humidity; 
        document.getElementById('sens-pres').innerText = latestMessage.BME280.Pressure;
        document.getElementById('sens-descr').innerText = getDetailedFeeling(latestMessage.BME280.Temperature, latestMessage.BME280.Humidity);
    });
    
    client.on('error', function (err) {
        console.error("Connection error: ", err);
    });  
</script>
